{"version":3,"file":"apiz-vue.umd.js","sources":["../src/index.ts"],"sourcesContent":["/* global DEBUG */\n// tslint:disable-next-line\nimport { APIz, APIzOptions, APIzInstance, HTTPMethodLowerCase, APIGroup, APIInfo } from 'apiz-ng';\nimport { config } from 'tinyjx';\n// tslint:disable-next-line\nimport Client, { APIzRawRequestOptions, APIzClientType, APIzClientMeta, APIzClientConstructorOptions } from 'apiz-browser-client';\nimport { VueConstructor as _Vue } from 'vue';\n\nlet installed = false;\n\ntype Options = APIzOptions<APIzRawRequestOptions, APIzClientType, APIzClientMeta, HTTPMethodLowerCase> & APIzClientConstructorOptions & {\n\tmeta: APIGroup<Record<string, APIInfo<APIzClientType, APIzClientMeta>>>\n};\n\ntype Instance = APIzInstance<APIzRawRequestOptions, Record<string, APIInfo<APIzClientType, APIzClientMeta>>, HTTPMethodLowerCase>;\n\ninterface NamedInstance {\n\tname: string;\n\tapiGroup: Instance;\n};\n\n// type APIs = Instance | Array<NamedInstance> | NamedInstance;\n\nfunction APIs(options: Options): Instance {\n\t// 这里不用new本来是没关系的, 但是他妈的V8有个bug...\n\t// 但是受限于TS的类型检查我又不能在这里用new\n\t// 那就只能在下面修复这个问题了\n\treturn APIz<APIzRawRequestOptions, APIzClientType, APIzClientMeta, HTTPMethodLowerCase>(options.meta, {\n\t\timmutable: true,\n\t\t// defaultType: 'json',\n\t\tclient: Client(options),\n\t\t...options\n\t});\n}\n\n// function isAnonymous(apis: any): apis is Instance {\n// \treturn apis instanceof APIz;\n// }\n\n// tslint:disable-next-line\nAPIs.install = function (Vue: _Vue, { pool = 5 }: { pool?: number | boolean } = {}) {\n\tif (installed) {\n\t\treturn;\n\t}\n\tinstalled = true;\n\n\tconfig({\n\t\tpool\n\t});\n\n\t// 其实我只想要hook根实例的beforeCreate而不是所有,\n\t// 然而好像没有什么很好的办法, 那就只能这样了\n\t// 至于为什么不直接通过options传入参数然后挂在\n\t// prototype上, 这样就可以不用使用mixin了, 因为\n\t// 我就希望API的调用方式是显式从根实例传入需要的参数\n\t// 而options则作为一些全局性的配置\n\tVue.mixin({\n\t\tbeforeCreate(): void | never {\n\t\t\t// 判断一下$root, 短路求值有利于减少其他组件实例化的判断\n\t\t\tif (this.$root === this && this.$options && (this.$options as any).apis) {\n\t\t\t\tconst apis = (this.$options as any).apis;\n\t\t\t\tswitch (true) {\n\t\t\t\t\t// switch true的话类型保护不起作用啊...\n\t\t\t\t\t// 看来只能手动as了\n\t\t\t\t\t// 本来instanceof是没什么问题的, 但是V8最近的版本有个bug, 这里会得到false\n\t\t\t\t\t// 所以换Object.getPrototypeOf\n\t\t\t\t\t// case apis instanceof APIz:\n\t\t\t\t\tcase Object.getPrototypeOf(Object.getPrototypeOf(apis)) === APIz.prototype:\n\t\t\t\t\t\tVue.prototype.$apis = apis as Instance;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase Array.isArray(apis):\n\t\t\t\t\t\t(apis as Array<NamedInstance>).forEach(item => Vue.prototype[item.name] = item.apiGroup);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase typeof apis.name === 'string' && apis.apiGroup instanceof APIz:\n\t\t\t\t\t\tVue.prototype[apis.name] = apis.apiGroup as Instance;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tdefault:\n\t\t\t\t\t\tthrow new TypeError('apis must be an Object or an Array');\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t});\n};\n\nif (window && (window as any).Vue) {\n\t(window as any).Vue.use(APIs);\n}\n\nexport default APIs;"],"names":["installed","APIs","options","APIz","meta","immutable","client","Client","install","Vue","pool","config","mixin","beforeCreate","$root","$options","apis","Object","getPrototypeOf","prototype","$apis","Array","isArray","forEach","item","name","apiGroup","TypeError","window","use"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;EAQA,IAAIA,SAAS,GAAG,KAAhB;AAWC;EAID,SAASC,IAAT,CAAcC,OAAd;EACC;EACA;EACA;EACA,SAAOC,WAAI,CAA6ED,OAAO,CAACE,IAArF;EACVC,IAAAA,SAAS,EAAE,IADD;EAEV;EACAC,IAAAA,MAAM,EAAEC,MAAM,CAACL,OAAD;EAHJ,KAIPA,OAJO,EAAX;EAMA;EAGD;EACA;EAEA;;;EACAD,IAAI,CAACO,OAAL,GAAe,UAAUC,GAAV;kCAAiE;yBAA1CC;QAAAA,8BAAO;;EAC5C,MAAIV,SAAJ,EAAe;EACd;EACA;;EACDA,EAAAA,SAAS,GAAG,IAAZ;EAEAW,EAAAA,aAAM,CAAC;EACND,IAAAA,IAAI,EAAJA;EADM,GAAD,CAAN;EAKA;EACA;EACA;EACA;EACA;;EACAD,EAAAA,GAAG,CAACG,KAAJ,CAAU;EACTC,IAAAA,YADS;EAER;EACA,UAAI,KAAKC,KAAL,KAAe,IAAf,IAAuB,KAAKC,QAA5B,IAAyC,KAAKA,QAAL,CAAsBC,IAAnE,EAAyE;EACxE,YAAMA,IAAI,GAAI,KAAKD,QAAL,CAAsBC,IAApC;;EACA,gBAAQ,IAAR;EACC;EACA;EACA;EACA;EACA;EACA,eAAKC,MAAM,CAACC,cAAP,CAAsBD,MAAM,CAACC,cAAP,CAAsBF,IAAtB,CAAtB,MAAuDb,WAAI,CAACgB,SAAjE;EACCV,YAAAA,GAAG,CAACU,SAAJ,CAAcC,KAAd,GAAsBJ,IAAtB;EACA;;EACD,eAAKK,KAAK,CAACC,OAAN,CAAcN,IAAd,CAAL;EACEA,YAAAA,IAA6B,CAACO,OAA9B,CAAsC,UAAAC,IAAI;EAAA,qBAAIf,GAAG,CAACU,SAAJ,CAAcK,IAAI,CAACC,IAAnB,IAA2BD,IAAI,CAACE,QAApC;EAAA,aAA1C;EACD;;EACD,eAAK,OAAOV,IAAI,CAACS,IAAZ,KAAqB,QAArB,IAAiCT,IAAI,CAACU,QAAL,YAAyBvB,WAA/D;EACCM,YAAAA,GAAG,CAACU,SAAJ,CAAcH,IAAI,CAACS,IAAnB,IAA2BT,IAAI,CAACU,QAAhC;EACA;;EACD;EACC,kBAAM,IAAIC,SAAJ,CAAc,oCAAd,CAAN;EAhBF;EAkBA;EACD;EAxBQ,GAAV;EA0BA,CA1CD;;EA4CA,IAAIC,MAAM,IAAKA,MAAc,CAACnB,GAA9B,EAAmC;EACjCmB,EAAAA,MAAc,CAACnB,GAAf,CAAmBoB,GAAnB,CAAuB5B,IAAvB;EACD;;;;;;;;"}